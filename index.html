<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Drowsiness Detector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{--bg:#121212;--fg:#fff;--warn:#f33;--panel:#1f1f1f}
    body{margin:0;padding:1rem;background:var(--bg);color:var(--fg);font-family:sans-serif}
    h1{margin:0 0 1rem;text-align:center}
    .video-box{width:512px;height:512px;position:relative;margin:0 auto;border:2px solid #444;border-radius:8px;overflow:hidden}
    video,canvas{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
    .panel{width:512px;margin:1rem auto;padding:1rem;background:var(--panel);border-radius:8px}
    .alert{color:var(--warn);font-weight:bold}
  </style>
</head>
<body>
  <h1>Drowsiness Detector</h1>
  <div class="video-box">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="canvas"></canvas>
  </div>
  <div class="panel">
    <div>Status: <span id="status">Loading...</span></div>
    <div>EAR: <span id="ear">–</span></div>
    <div class="alert" id="alert"></div>
  </div>

  <!-- Local MediaPipe + TFJS -->
  <script src="mediapipe/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
  <script>
  // --- config ---
  const EAR_THRESHOLD = 0.25;
  const LEFT_IDX  = [362,385,387,263,373,380];
  const RIGHT_IDX = [33,160,158,133,153,144];

  // --- UI refs ---
  const video   = document.getElementById('video');
  const canvas  = document.getElementById('canvas');
  const ctx     = canvas.getContext('2d');
  const status  = document.getElementById('status');
  const earEl   = document.getElementById('ear');
  const alertEl = document.getElementById('alert');

  let model, earHistory=[];

  // compute EAR
  function getEAR(pts) {
    const [p1,p2,p3,p4,p5,p6] = pts;
    const A = Math.hypot(p2.x-p6.x, p2.y-p6.y);
    const B = Math.hypot(p3.x-p5.x, p3.y-p5.y);
    const C = Math.hypot(p1.x-p4.x, p1.y-p4.y);
    return (A+B)/(2*C);
  }

  async function setupCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({ video:true });
    video.srcObject = stream;
    await new Promise(r=>video.onloadedmetadata=r);
    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;
  }

  async function loadModel() {
    // Tell TFJS to load from our local folder
    model = await faceLandmarksDetection.load(
      faceLandmarksDetection.SupportedPackages.mediapipeFacemesh,
      { 
        maxFaces:1,
        modelUrl: 'tfjs_models/model.json'
      }
    );
  }

  async function detectLoop() {
    const predictions = await model.estimateFaces({input:video, flipHorizontal:true});
    ctx.clearRect(0,0,canvas.width,canvas.height);

    if (predictions.length) {
      status.textContent = 'Face Detected ✅';
      const keypoints = predictions[0].keypoints;
      const left  = LEFT_IDX.map(i=>keypoints[i]);
      const right = RIGHT_IDX.map(i=>keypoints[i]);
      const ear   = ((getEAR(left)+getEAR(right))/2).toFixed(3);
      earEl.textContent = ear;
      earHistory.push(parseFloat(ear));
      if (earHistory.length>10) earHistory.shift();
      const avg = earHistory.reduce((a,b)=>a+b)/earHistory.length;
      alertEl.textContent = avg<EAR_THRESHOLD ? '⚠️ Drowsiness!' : '';
      // draw
      [...left,...right].forEach(p=>{
        ctx.beginPath();
        ctx.arc(p.x*p.videoWidth, p.y*p.videoHeight, 2,0,2*Math.PI);
        ctx.fillStyle = 'lime';
        ctx.fill();
      });
    } else {
      status.textContent = 'No Face ❌';
      earEl.textContent = '–';
      alertEl.textContent = '';
    }
    requestAnimationFrame(detectLoop);
  }

  // --- service worker registration (for caching) ---
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
      .catch(console.error);
  }

  // --- kick off ---
  (async()=>{
    await setupCamera();
    status.textContent='Loading model…';
    const t0=performance.now();
    await loadModel();
    const t1=performance.now();
    status.textContent=`Model loaded in ${((t1-t0)/1000).toFixed(2)}s`;
    detectLoop();
  })();
  </script>
</body>
</html>
